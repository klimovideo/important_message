# 📋 Подробная схема работы бота "Важные сообщения"

## 🎯 Назначение бота
Бот предназначен для мониторинга сообщений в различных Telegram чатах и каналах, автоматического определения их важности с помощью искусственного интеллекта (GigaChat) и уведомления пользователей о важных сообщениях.

## 🏗️ Архитектура системы

### 1. Основные компоненты

```
┌─────────────────────────────────────────────────────────────┐
│                     ГЛАВНЫЙ БОТ (bot.py)                     │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐  ┌──────────────┐  ┌─────────────────┐  │
│  │   main.py   │  │   config.py  │  │    utils.py     │  │
│  │ (точка входа)│  │ (настройки)  │  │  (утилиты)      │  │
│  └─────────────┘  └──────────────┘  └─────────────────┘  │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐  │
│  │              ОБРАБОТЧИКИ КОМАНД                      │  │
│  │  • /start - регистрация пользователя                │  │
│  │  • /menu - главное меню                             │  │
│  │  • /admin - админ-панель                            │  │
│  │  • /submit_post - предложить пост                   │  │
│  └─────────────────────────────────────────────────────┘  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────┐
│                    СЕРВИСНЫЕ МОДУЛИ                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌──────────────────┐  ┌────────────────┐  ┌────────────┐ │
│  │  ai_service.py   │  │admin_service.py│  │userbot.py  │ │
│  │                  │  │                │  │            │ │
│  │ • Оценка важности│  │• Управление    │  │• Мониторинг│ │
│  │   через GigaChat │  │  публикациями  │  │  закрытых  │ │
│  │ • Анализ текста  │  │• Модерация     │  │  каналов   │ │
│  └──────────────────┘  └────────────────┘  └────────────┘ │
│                                                             │
└─────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────┐
│                    ХРАНИЛИЩЕ ДАННЫХ                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌──────────────────┐  ┌────────────────┐  ┌────────────┐ │
│  │   models.py      │  │  JSON файлы:   │  │ Сессии:    │ │
│  │                  │  │                │  │            │ │
│  │ • UserPreferences│  │• bot_config    │  │• userbot   │ │
│  │ • BotConfig      │  │• user_prefs    │  │  session   │ │
│  │ • PendingPost    │  │• pending_posts │  │            │ │
│  │ • Storage        │  │                │  │            │ │
│  └──────────────────┘  └────────────────┘  └────────────┘ │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2. Типы пользователей

```
┌─────────────────────┐         ┌──────────────────────┐
│  ОБЫЧНЫЙ ПОЛЬЗОВАТЕЛЬ│         │    АДМИНИСТРАТОР     │
├─────────────────────┤         ├──────────────────────┤
│ • Предложить пост   │         │ • Все функции обычного│
│ • Предложить канал  │         │   пользователя        │
│ • Просмотр канала   │         │ • Мониторинг каналов  │
│ • Справка           │         │ • Управление постами  │
│                     │         │ • Настройки бота      │
│                     │         │ • Управление userbot  │
│                     │         │ • Управление админами │
└─────────────────────┘         └──────────────────────┘
```

## 🔄 Алгоритм работы бота

### 1. Запуск и инициализация

```
СТАРТ
  │
  ├─► Загрузка переменных окружения (.env)
  │     • TELEGRAM_TOKEN (токен бота)
  │     • CLIENT_ID, SECRET (для GigaChat)
  │     • TELEGRAM_API_ID, API_HASH (для userbot)
  │
  ├─► Проверка обязательных настроек
  │     • Если нет токена → завершение с ошибкой
  │     • Если нет GigaChat → работа в упрощенном режиме
  │
  ├─► Загрузка данных из JSON файлов
  │     • bot_config.json (настройки бота)
  │     • user_preferences.json (данные пользователей)
  │     • pending_posts.json (очередь постов)
  │
  ├─► Создание Application (telegram.ext)
  │
  ├─► Регистрация обработчиков
  │     • Команды (/start, /menu, /admin, /submit_post)
  │     • Callback кнопки (inline keyboards)
  │     • Текстовые сообщения
  │     • Пересланные сообщения
  │
  ├─► Запуск userbot (если включен)
  │     • Авторизация через Pyrogram
  │     • Подключение к мониторингу
  │
  └─► Запуск polling (ожидание сообщений)
```

### 2. Обработка команд пользователя

#### Команда /start
```
/start
  │
  ├─► Проверка: пользователь уже зарегистрирован?
  │     │
  │     ├─ ДА → Показать приветствие и главное меню
  │     │
  │     └─ НЕТ → Создать нового пользователя
  │              • user_id
  │              • username
  │              • настройки по умолчанию
  │
  └─► Отобразить главное меню (Reply Keyboard)
        • Для админов: расширенное меню
        • Для обычных: базовое меню
```

#### Главное меню (Reply Keyboard)
```
┌─────────────────────────────────────┐
│        МЕНЮ ДЛЯ АДМИНОВ             │
├─────────────────────────────────────┤
│ [📊 Мониторинг] [📢 Канал публикации]│
│ [👥 Администраторы] [⚙️ Настройки]   │
│ [🤖 Userbot] [ℹ️ Справка]           │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│     МЕНЮ ДЛЯ ОБЫЧНЫХ ПОЛЬЗОВАТЕЛЕЙ  │
├─────────────────────────────────────┤
│ [📝 Предложить пост] [📢 Предложить  │
│                         канал]       │
│ [📬 Канал важных] [ℹ️ Справка]      │
│     сообщений                       │
└─────────────────────────────────────┘
```

### 3. Мониторинг сообщений

#### Активный мониторинг (бот - администратор)
```
Новое сообщение в канале/чате
  │
  ├─► Проверка: бот является админом?
  │     │
  │     └─ ДА → Обработка сообщения
  │              │
  │              ├─► Извлечение данных
  │              │     • ID сообщения
  │              │     • Текст
  │              │     • Автор
  │              │     • Время
  │              │
  │              ├─► Поиск пользователей, мониторящих источник
  │              │
  │              ├─► Для каждого пользователя:
  │              │     │
  │              │     ├─► Оценка важности (AI)
  │              │     │
  │              │     └─► Если важность > порог
  │              │           • Отправить уведомление
  │              │           • Предложить публикацию
  │              │
  │              └─► Автоматическая публикация (если включена)
  │
  └─► Конец обработки
```

#### Пассивный мониторинг (пересланные сообщения)
```
Пользователь переслал сообщение боту
  │
  ├─► Извлечение информации об источнике
  │     • ID канала/чата
  │     • Название
  │     • Тип (канал/чат)
  │
  ├─► Проверка: источник в списке мониторинга?
  │     │
  │     ├─ ДА → Анализ важности
  │     │        • Оценка через AI
  │     │        • Уведомление если важно
  │     │
  │     └─ НЕТ → Предложить добавить в мониторинг
  │
  └─► Конец обработки
```

#### Userbot мониторинг (для закрытых каналов)
```
Userbot получил сообщение
  │
  ├─► Проверка: канал/чат в списке мониторинга?
  │     │
  │     └─ ДА → Передача основному боту
  │              │
  │              ├─► Создание объекта Message
  │              │
  │              ├─► Поиск пользователей-подписчиков
  │              │
  │              └─► Обработка как в активном мониторинге
  │
  └─► Конец обработки
```

### 4. Оценка важности сообщений

```
Сообщение для анализа
  │
  ├─► Проверка доступности GigaChat
  │     │
  │     ├─ ДОСТУПЕН → AI анализ
  │     │              │
  │     │              ├─► Формирование промпта
  │     │              │     • Текст сообщения
  │     │              │     • Контекст (автор, время, источник)
  │     │              │     • Предпочтения пользователя
  │     │              │
  │     │              ├─► Отправка в GigaChat
  │     │              │
  │     │              ├─► Получение оценки (0.0-1.0)
  │     │              │
  │     │              └─► Применение дополнительных критериев
  │     │
  │     └─ НЕДОСТУПЕН → Упрощенный анализ
  │                      • Поиск ключевых слов
  │                      • Проверка длины
  │                      • Базовые правила
  │
  ├─► Корректировка оценки
  │     • Boost keywords (+0.2)
  │     • Reduce keywords (-0.2)
  │     • Важные источники (+0.1)
  │     • Длина сообщения
  │     • Время публикации
  │
  └─► Финальная оценка (0.0-1.0)
```

### 5. Публикация важных сообщений

```
Важное сообщение (оценка > порог)
  │
  ├─► Проверка настроек публикации
  │     │
  │     ├─► auto_publish_enabled = true?
  │     │     │
  │     │     ├─► require_admin_approval = true?
  │     │     │     │
  │     │     │     ├─ ДА → Добавить в очередь модерации
  │     │     │     │        • Создать PendingPost
  │     │     │     │        • Уведомить админов
  │     │     │     │        • Ждать решения
  │     │     │     │
  │     │     │     └─ НЕТ → Автоматическая публикация
  │     │     │              • Форматирование
  │     │     │              • Отправка в канал
  │     │     │
  │     │     └─► auto_publish_enabled = false
  │     │           • Только уведомление пользователю
  │     │
  │     └─► Канал публикации настроен?
  │           │
  │           ├─ ДА → Публикация
  │           │
  │           └─ НЕТ → Логирование ошибки
  │
  └─► Конец обработки
```

### 6. Модерация постов

```
┌────────────────────────────────────────┐
│         ЖИЗНЕННЫЙ ЦИКЛ ПОСТА          │
├────────────────────────────────────────┤
│                                        │
│  PENDING (ожидает)                     │
│      │                                 │
│      ├─► Админ одобрил → APPROVED      │
│      │                     │           │
│      │                     └─► PUBLISHED│
│      │                                 │
│      └─► Админ отклонил → REJECTED    │
│                                        │
└────────────────────────────────────────┘
```

### 7. Управление настройками

#### Глобальные настройки (BotConfig)
```
bot_config.json
  │
  ├─► admin_ids - список ID администраторов
  ├─► publish_channel_id - канал для публикаций
  ├─► importance_threshold - порог важности (0.7)
  ├─► importance_criteria - критерии оценки
  │     • keywords_boost - слова, повышающие важность
  │     • keywords_reduce - слова, снижающие важность
  │     • sources_boost - важные источники
  │     • min/max_message_length - ограничения длины
  ├─► auto_publish_enabled - автопубликация
  └─► require_admin_approval - требовать одобрения
```

#### Пользовательские настройки (UserPreferences)
```
user_preferences.json
  │
  ├─► user_id - ID пользователя
  ├─► username - имя пользователя
  ├─► monitored_chats - список чатов для мониторинга
  ├─► monitored_channels - список каналов
  ├─► keywords - важные ключевые слова
  ├─► exclude_keywords - игнорируемые слова
  ├─► importance_threshold - персональный порог
  └─► current_state - текущее состояние диалога
```

## 🔐 Безопасность и права доступа

### Уровни доступа
```
┌─────────────────┐
│ ОБЫЧНЫЙ ПОЛЬЗОВАТЕЛЬ│
├─────────────────┤
│ • Чтение канала │
│ • Предложения   │
│ • Базовые функции│
└─────────────────┘
        ▲
        │ Повышение прав
        │
┌─────────────────┐
│  АДМИНИСТРАТОР  │
├─────────────────┤
│ • Все функции   │
│ • Модерация     │
│ • Настройки     │
│ • Управление    │
└─────────────────┘
```

### Проверки безопасности
1. **Авторизация команд** - проверка прав перед выполнением
2. **Валидация данных** - проверка входящих данных
3. **Ограничение частоты** - защита от спама
4. **Логирование действий** - аудит важных операций

## 📊 Потоки данных

### Поток обработки сообщения
```
Источник сообщения
     │
     ├─► Telegram API
     │        │
     │        ├─► Bot (если админ в канале)
     │        ├─► Userbot (если закрытый канал)
     │        └─► Пересылка (ручной мониторинг)
     │
     ├─► Обработка и анализ
     │        │
     │        ├─► AI оценка (GigaChat)
     │        ├─► Применение критериев
     │        └─► Финальная оценка
     │
     ├─► Принятие решения
     │        │
     │        ├─► Важно → Уведомление + Публикация
     │        └─► Не важно → Игнорировать
     │
     └─► Сохранение статистики
```

## 🛠️ Обработка ошибок

### Стратегия обработки ошибок
```
Ошибка
  │
  ├─► Критическая?
  │     │
  │     ├─ ДА → Логирование + Уведомление админа
  │     │        + Graceful shutdown
  │     │
  │     └─ НЕТ → Логирование + Продолжение работы
  │              + Retry механизм (3 попытки)
  │
  └─► Сохранение состояния перед завершением
```

### Типы ошибок
1. **Сетевые ошибки** - повтор через backoff
2. **API лимиты** - очередь с задержкой
3. **Недоступность AI** - fallback на простой анализ
4. **Ошибки данных** - валидация и восстановление

## 📈 Масштабирование

### Оптимизации производительности
1. **Кеширование токенов** - для GigaChat API
2. **Batch обработка** - группировка сообщений
3. **Асинхронная обработка** - параллельные задачи
4. **JSON файлы** - простое хранилище без БД

### Ограничения
- Максимум 50 мониторимых источников на пользователя
- Лимит 100 сообщений в минуту для анализа
- Размер сообщения до 4000 символов
- До 1000 активных пользователей (JSON storage)

## 🔧 Расширяемость

### Точки расширения
1. **Новые AI провайдеры** - добавление в ai_service.py
2. **Дополнительные критерии** - расширение ImportanceCriteria
3. **Новые типы источников** - поддержка других платформ
4. **Плагины обработки** - система хуков для сообщений

### Интеграции
- **Внешние API** - через ai_service
- **Базы данных** - замена JSON на SQL
- **Очереди сообщений** - для высоких нагрузок
- **Микросервисы** - разделение компонентов